# Bakuage Stem Enhancer (local)

AI生成楽曲のステム分割で起きがちな以下の問題に特化した「ステム修復・エンハンス」ツールです。

- ステム分割由来のアーティファクト（バブリング/金属感/ざらつき/粒状ノイズ）
- トランジェントの喪失（アタックが鈍い、抜けない）
- ヒスノイズ/サチュレーション由来の高域ノイズ
- 生成由来のシンバル問題（サスティンが不自然に長い / デジタルな"fizz" / 高域が位相っぽく広がる）
- ステム間のタイミング/極性（polarity）ズレを検出して整列（簡易フェーズアライン）

本プロジェクトは **ローカル実行** を前提にしています（SaaS不要）。UIはGradioで提供します。

---

## できること（現バージョン）

- ステム一括インポート（複数ファイル）
- 楽器推定（ファイル名/特徴量ベース）＋手動割当（YAML/JSON編集）
- アーティファクト低減（STFTベースのソフト・スペクトラルゲート＋マスク平滑化）
- ヒス低減（高域を中心としたスペクトラルゲート）
- トランジェント復元（マルチバンド・トランジェントシェイパ）
- シンバル修復（ドラム中心）
  - 高域サスティンを短くする（Decay shaper）
  - "fizz"/粒状感を抑える（高域のみのスペクトル平滑化）
  - 位相っぽい高域の広がりを抑える（高域のみM/Sナロー）
- 位相/タイミング整列
  - GCC-PHATで遅延推定 → サンプルシフト
  - 0遅延相関で極性反転を自動判定
  - オプション：周波数ごとの定常位相差をざっくり補正（phase-match）
- 出力
  - 修復済みステムを個別WAVで書き出し
  - まとめてZIPでダウンロード

---

## クイックスタート（Mac）

1) Python 3.10+ を用意

2) 依存関係をインストール

```bash
cd bakuage-stem-enhancer
python3 -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

3) UI起動

```bash
python app.py
```

起動後、表示されたURLをブラウザで開きます（通常は `http://127.0.0.1:7860`）。

---

## 使い方

1. 「Stems」へ複数のステム音源をアップロード
2. （任意）「MIDI」へ各ステムに対応するMIDIをアップロード
3. 「Instrument mapping」で推定結果を確認
   - 必要なら編集してから「Apply mapping」を押す
4. 「Run」ボタンで処理
5. 生成されたZIP（修復済みステム一式）をダウンロード

---

## 注意点

- 現状は “AIモデルで完全修復” ではなく、主に **DSPで破綻を目立たなくし、編集耐性を上げる** 方向の実装です。
- 「位相を完全に元へ戻す」は逆問題のため不可能ですが、
  - タイミングのズレ
  - 極性反転
  - 定常的な位相回転
  については改善可能です。
- 入力はWAV推奨です（mp3等は環境によって読めない場合があります）。

---

## CLI（バッチ処理）

UI以外にCLIも用意しています。

```bash
python -m stem_enhance.cli \
  --stems ./stems/*.wav \
  --out ./out \
  --phase_align auto \
  --preset auto
```

---

## ライセンス

このプロジェクトはサンプル実装です。必要に応じて社内/個人利用向けに調整してください。
